
  <!DOCTYPE html>
  <html>
    <head>
      <meta charset="utf-8">
      <title>Probable Futures Map</title>
      <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
      <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
      <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-compare/v0.4.0/mapbox-gl-compare.css" type="text/css">
      <style>
        body {margin: 0; padding: 0; font-family: LinearSans, Arial, Helvetica, sans-serif; font-size: 16px; color: #2a172d; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;overflow-x: hidden;}
        a {color: #1c101e;}
        a:hover {color: #851fff;}
        @font-face { font-family: "LinearSans"; src: url("https://pf-fonts.s3.us-west-2.amazonaws.com/LinearSans-Regular.otf") format("opentype"); font-weight: 400; font-style: normal;}
        @font-face { font-family: "LinearSans"; src: url("https://pf-fonts.s3.us-west-2.amazonaws.com/linear-sans-semibold.eot"); src: url("https://pf-fonts.s3.us-west-2.amazonaws.com/linear-sans-semibold.eot?#iefix") format("embedded-opentype"), url("https://pf-fonts.s3.us-west-2.amazonaws.com/linear-sans-semibold.woff2") format("woff2"), url("https://pf-fonts.s3.us-west-2.amazonaws.com/linear-sans-semibold.woff") format("woff"); font-weight: 600; font-style: normal;}
        @font-face { font-family: "RelativeMono"; src: url("https://pf-fonts.s3.us-west-2.amazonaws.com/relative-mono-10-pitch-pro.otf") format("opentype"); font-weight: 400; font-style: normal;}
        @font-face { font-family: "Cambon"; src: url("https://pf-fonts.s3.us-west-2.amazonaws.com/Cambon-Regular.otf") format("opentype"); font-weight: 400; font-style: normal;}
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .mapboxgl-ctrl-top-right { top: 50%; transform: translateY(-50%);}
        .mapboxgl-ctrl.mapboxgl-ctrl-group { box-shadow: 0 3px 5px 0 rgb(56 22 63 / 50%); border-radius: 6px; background-color: #fdfdfd; margin-right: 20px;} 
        .mapboxgl-ctrl.mapboxgl-ctrl-group button { width: 35px; height: 35px; border: none; outline: 0; font-family: "LinearSans"; color: #1b1a1c; border-bottom-left-radius: 6px; border-bottom-right-radius: 6px;}
        .mapboxgl-ctrl.mapboxgl-ctrl-group button:first-child { border-top-left-radius: 6px; border-top-right-radius: 6px; border-bottom: 1px solid rgba(151,151,151,0.5); border-bottom-left-radius: unset; border-bottom-right-radius: unset;}
        .mapboxgl-ctrl.mapboxgl-ctrl-group button:last-child {display: none;}
        .mapboxgl-map {font: unset;}
        .mapboxgl-ctrl-attrib-inner a {font-size: 10px; font-family: Helvetica Neue, Arial, Helvetica, sans-serif; line-height: 20px;}
        .mapboxgl-ctrl-attrib.mapboxgl-compact {margin-bottom: 5px;}
        .mapboxgl-ctrl-bottom-left {left: unset; right: 45px; z-index:1;}
        @media (min-width: 641px) {.mapboxgl-ctrl-bottom-left {right: 10px; bottom: 15px;}}
        @media (min-width: 1200px) {.mapboxgl-ctrl-bottom-left {bottom: 15px; left: unset; right: 10px;}}
        .mapboxgl-ctrl-bottom-right {right: 0; bottom: 0;}
        .mapbox-improve-map {font-weight: 700;}
        /*popover*/
        .popover-title {display: block;max-width: 200px;color: #1c101e;font-size: 10px;font-weight: 600;line-height: 14px;margin-right: 25px;}
        .popover-title:first-letter{text-transform: uppercase;}
        .popover-description{font-weight: 400;font-size: 10px;max-width: 209px;line-height: 20px;}
        .popover-no-data {display: block;color: #000000;font-weight: 600;letter-spacing: 0;text-align: center;margin-top: 10px;margin-bottom: 16px;font-size: 20px;}
        .popover-row-container {display: flex;justify-content: center;margin-top: 10px;padding-bottom: 18px;text-align: center;gap: 20px;}
        .popover-value-container {display: flex;flex-direction: column;align-items: center;justify-content: space-around;gap: 5px;}
        .popover-value {display: block;color: #000000;font-weight: 600;letter-spacing: 0;}
        .popover-label {display: block;max-width: 80px;color: #000000;font-size: 10px;letter-spacing: 0;line-height: 10px;text-align: center;box-sizing: border-box;padding: 0px 4px;}
        .popover-label:first-letter{text-transform: lowercase;}
        .popover-mean-frequency-text {display: block;color: #000000;font-weight: 600;letter-spacing: 0;font-size: 20px;}
        .popover-avg-value {display: block;color: #000000;font-weight: 600;letter-spacing: 0;}
        .mapboxgl-popup-content{background-color: #fdfdfd;border-radius: 0;border: 1px solid #2a172d;padding: 16px 16px 0;box-sizing: border-box;box-shadow: none;}
        .mapboxgl-popup-close-button{position: absolute;top: 8px;right: 12px;font-size: 25px;width: 20px;height: 20px;}
        .mapboxgl-popup-close-button:hover{background: transparent;}
        .mapboxgl-popup-tip{width: 12px;height: 12px;transform: rotate(45deg);background-color: #fdfdfd;border-width: 1px !important;margin-bottom: -8px;border-left: 1px solid #2a172d;border-top: 1px solid #2a172d!important;box-sizing: content-box;align-self: center;border-bottom-color: #fff;}
        #beforeMap, #afterMap {overflow: hidden;position: absolute;height: 100%;z-index: 1;user-select: none;width: 100%;}
        .comparison-container {overflow: hidden;position: relative;height: 100%;z-index: 1;}
        .mapboxgl-compare {background-color: rgb(42, 23, 45);height: 100%;position: absolute;width: 2px;z-index: 1;}
        .mapboxgl-compare .compare-swiper-vertical {background-color: #1b1a1c;background-repeat: no-repeat, no-repeat;background-size: 41px;border-radius: 50%;box-shadow: #f8f9f3 0 0 0 2px inset;color: #f8f9f3;cursor: ew-resize;display: inline-block;height: 40px;left: -20px;margin: -20px 1px 0;position: absolute;top: 50%;width: 40px;}
        .mapboxgl-compare .compare-swiper-vertical::before,
        .mapboxgl-compare .compare-swiper-vertical::after {background-color: #1b1a1c;border: 1px solid #fefffc;color: #f8f9f3;display: block;font-family: RelativeMono,monospace;font-size: 15px;line-height: 1;padding: 2px 0 4px 0;position: absolute;text-align: center;top: 10px;width: 62px;}
        .mapboxgl-compare .compare-swiper-vertical::before {content: "0.5°C";left: -71px;}
        .mapboxgl-compare .compare-swiper-vertical::after {content: "2°C";right: -71px;}
        /*header*/
        .embeddable-map-header {font-family: LinearSans, Arial, Helvetica, sans-serif;border: 1px solid #2a172d;background-color: #fdfdfd;padding: 15px 10px;position: relative;font-size: 16px;top: 20px;left: 20px;margin-right: 40px;display: inline-block;z-index: 1;}
        .embeddable-map-title {font-size: 10px;font-weight: 600;letter-spacing: 0.8px;line-height: 11px;text-transform: uppercase;margin-bottom: 5px;}
        .embeddable-map-header-description {margin: 0;font-size: 18px;font-weight: bold;}
        /*key*/
        .embeddable-key-container {position: absolute;min-width: 280px;top: unset;right: unset;left: 20px;bottom: 20px;z-index: 1;width: auto;font-family: LinearSans, Arial, Helvetica, sans-serif;}
        .map-key-container {border: 1px solid #2a172d;padding: 12px 18px 9px;background-color: #fdfdfd;border-bottom: 1px solid #2a172d;}
        .climate-zones-key-container{white-space: nowrap;box-sizing: content-box;border: 1px solid #2a172d;padding: 0px;padding-left: 16px;width: auto;height: 95px;overflow-x: hidden;}
        .embeddable-key-content {display: inline-block;width: 100%;}
        .map-key-header {display: flex;flex-direction: row;justify-content: space-between;align-items: center;margin-bottom: 10px;}
        .map-key-label {display: block;font-size: 10px;color: #2a172d;font-weight: 600;letter-spacing: 0.8px;line-height: 11px;text-transform: uppercase;margin-bottom: 8px;}
        .map-key-row {display: flex;width: 100%;}
        .map-key-bins-container {display: flex;align-items: flex-start;width: 100%;}
        .map-key-bin-container {display: flex;flex-direction: column;margin-right: 2px;min-width: 43px;flex: 1;max-width: 120px;}
        .map-key-color {height: 12px;}
        .map-key-bin {font-family: "RelativeMono", Courier, monospace;color: #2a172d;font-size: 9px;letter-spacing: 0;line-height: 16px;text-align: center;margin-top: 2px;display: flex;justify-content: space-evenly;}
        .map-key-bin .dash {font-size: 13px;}
        .map-key-inner-bin-label {display: flex;}
        .embeddable-bottom-link {position: absolute;left: 0;padding: 0 5px;background-color: rgba(255, 255, 255, 0.5);font-size: 12px;font-family: Helvetica Neue, Arial, Helvetica, sans-serif;line-height: 20px;color: rgba(0, 0, 0, 0.75);z-index: 3;cursor: pointer;text-decoration: none;bottom: 0;}
        @media (orientation: landscape) {.map-key-bin {font-size: 10px;}}
        @media (min-width: 768px) {.map-key-bin {font-size: 9px;}}
        @media (min-width: 1200px) {.map-key-bin {font-size: 13px;margin-top: 4px;}}
        @media (min-width: 1200px) {.map-key-color {height: 14px;}}
        @media (orientation: landscape) {.map-key-bin-container {min-width: 43px;}}
        @media (min-width: 768px) {.map-key-bin-container {min-width: 47px;}}
        @media (min-width: 1200px) {.map-key-bin-container {margin-right: 3px;min-width: 80px;}}
        @media (min-width: 768px) {.map-key-bins-container {margin-right: 13px;}}
        @media (min-width: 1200px) {.map-key-bins-container {margin-right: 0;}}
        @media (min-width: 1200px) {.map-key-label {margin-bottom: 8px;}}
        @media (min-width: 1200px) {.map-key-header { margin-bottom: 10px;}}
        /*Key toggle*/
        .embeddable-toggle {position: relative;width: 62px;height: 20px;background-color: #fdfdfd;border-radius: 4px;margin: 0 5px;border: 1px solid #2a172d;box-sizing: content-box;display: flex;font-family: "RelativeMono";font-size: 13px;letter-spacing: 0;line-height: 16px;text-align: center;user-select: none;}
        .embeddable-toggle .toggle-span {position: absolute;top: 2px;left: 3px;width: 28px;height: 16px;border-radius: 4px;transition: 0.2s;background-color: #2a172d;}
        .embeddable-toggle-label {display: flex;align-items: center;justify-content: space-between;cursor: pointer;}
        .embeddable-toggle-label:active .toggle-span {width: 30px;}
        .embeddable-toggle-label:hover .embeddable-toggle {border: 1px solid #8C6FF1;}
        .embeddable-toggle-label:hover .toggle-span {background-color: #8C6FF1;}
        .embeddable-toggle-input {display: none;}
        .embeddable-toggle-input:checked + .embeddable-toggle-label .toggle-span {left: calc(100% - 3px);transform: translateX(-100%);}
        .embeddable-toggle-option {flex: 1;   transition: color 0.6s ease;z-index: 1;margin-top: 2px;}
        @media (min-width: 1200px) {.embeddable-toggle-container {margin-bottom: 14px;}}
        @media (min-width: 1200px) {.embeddable-toggle {margin: 0 7px 0 9px;}}
        /* Climate Zones key*/
        .climate-zones-key-container {background-color: #fdfdfd;border-bottom: 1px solid #2a172d;border: 1px solid #2a172d;display: flex;align-items: center;}
        .cz-bins-container {display: grid;grid-template-columns: 150px 120px 170px 170px auto 0px;gap: 15px;}
        .cz-bin-container {display: flex;flex-direction: column;flex: 1;}
        .cz-color-bin-wrapper {display: flex;align-items: center;gap: 10px;}
        .cz-key-color {height: 10px;width: 10px;aspect-ratio: 1/1;}
        .cz-key-bin {color: #2a172d;font-size: 9px;letter-spacing: 0;line-height: 14px;margin-top: 2px;}
        @media (orientation: landscape) {.cz-key-bin {font-size: 10px;}}
        @media (min-width: 768px) {.cz-key-bin {font-size: 9px;}.dash {font-size: 18px;}}
        @media (min-width: 1200px) {.cz-key-bin {font-size: 12px;margin-top: 4px;}}
        @media (min-width: 1200px) {.embeddable-toggle-container {margin-bottom: 14px;}}
        @media (min-width: 1200px) {.embeddable-toggle {margin: 0 7px 0 9px;}}
      </style>
      <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
      <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-compare/v0.4.0/mapbox-gl-compare.js"></script>
      <!-- Open Graph / Facebook -->
      <meta property="og:title" content="Probable Futures Map" />
      <meta
        property="og:description"
        content="Probable Futures aims to increase the chances that the future is good. We offer useful tools to visualize climate change along with stories and insights to help people understand what those changes mean."
        data-react-helmet="true"
      />
      <meta property="og:type" content="website" />
      <meta
        property="og:image"
        content="http://probablefutures.org/assets/images/pf-gradient-1.jpg"
      />
      <meta property="og:image:width" content="1920" />
      <meta property="og:image:height" content="1080" />
      <meta property="og:url" content="http://probablefutures.org" />
  
      <!-- Twitter -->
      <meta name="twitter:title" content="Probable Futures Map" />
      <meta name="twitter:card" content="summary" />
      <meta
        name="twitter:description"
        content="Probable Futures aims to increase the chances that the future is good. We offer useful tools to visualize climate change along with stories and insights to help people understand what those changes mean."
        data-react-helmet="true"
      />
      <meta
        property="twitter:image"
        content="http://probablefutures.org/assets/images/pf-gradient-1.jpg"
      />
      <meta name="twitter:url" content="http://probablefutures.org" />
    </head>
    <body>
      <div id="map" style="display:none;"></div>
      <div id="comparison-container" style="display:block;" ><div id="beforeMap"></div><div id="afterMap"></div></div>
      <!-- HEADER -->
      <div class="embeddable-map-header">
        <div class="embeddable-map-title">Climate map</div>
      </div>
      <script>
        (function() {
          function cToF(value) {
            return Math.floor((value * 9) / 5 + 32);
          }
          function convertCToF(values) {
            if (values === undefined) return values;
            return Array.isArray(values) ? values.map(cToF) : cToF(values);
          }
          const datasetsWithMidValuesOnly = [40612, 40613, 40701, 40702, 40901];
          function getBinLabel(bins, index, unit, minValue, maxValue, step, tempUnit, isDiff=false, isFrequent=false){
            const isTempMap = unit.toLowerCase().includes("temp");

            const finalBins = isTempMap && tempUnit === "°F" ? (convertCToF(bins)) : bins;
            const finalMinValue =
              isTempMap && tempUnit === "°F" ? (convertCToF(minValue)) : minValue;
            const finalMaxValue =
              isTempMap && tempUnit === "°F" ? (convertCToF(maxValue)) : maxValue;
            const plusSign = isDiff && !isFrequent ? "+" : "";
            const prevBin = finalBins[index - 1];
            const curBin = finalBins[index];

            if (index > bins.length) {
              return [];
            }

            if (index === 0) {
              if (finalMinValue === 0 && finalMinValue === finalBins[index] - 1 && !isDiff) {
                return [finalMinValue.toString()];
              } else if (!isDiff) {
                return [finalMinValue.toString(), parseFloat((curBin - step).toFixed(1)).toString()];
              } else {
                return [curBin > 0 ? "< " + plusSign.concat(curBin.toString()) : "< " + curBin];
              }
            }

            if (!isDiff) {
              const firstBin = prevBin.toString();
              let secondBin = "";

              if (index === finalBins.length) {
                secondBin = finalMaxValue.toString();
              } else {
                secondBin = parseFloat((curBin - step).toFixed(1)).toString();
              }
              return [firstBin, secondBin];
            } else {
              if (index === finalBins.length) {
                return [
                  prevBin - 1 > 0
                    ? "> " + plusSign.concat((prevBin - 1).toString())
                    : "> " + (prevBin - 1).toString(),
                ];
              } else {
                if (prevBin === curBin - 1) {
                  return [prevBin > 0 ? plusSign.concat(prevBin.toString()) : prevBin.toString()];
                } else {
                  return [
                    prevBin > 0 ? plusSign.concat(prevBin.toString()) : prevBin.toString(),
                    curBin - 1 > 0 ? plusSign.concat((curBin - 1).toString()) : (curBin - 1).toString(),
                  ];
                }
              }
            }
          };

          function getLabelByValue(value,binningType,binningLabels,stops) {
            if (binningType === "range") {
              let labelIdx = -1;
              stops.forEach(function(stop, index){
                if (labelIdx === -1) {
                  if (index === 0 && value < stop) labelIdx = 0;
                  else {
                    let range = [stops[index - 1], stop];
                    if (value >= range[0] && value < range[1]) labelIdx = index;
                  }
                }
              });
              if (labelIdx==-1) {
                if(value>=stops[stops.length - 1]) {
                  labelIdx = stops.length;  
                }
              }
              return binningLabels[labelIdx];
            } else if (binningType === "number") {
              let labelIdx = 0;
              stops.forEach(function(stop, index){if (stop === value) labelIdx = index + 1;});
              return binningLabels[labelIdx];
            }
          }
          const MAP_VERSION_URL = "https://probablefutures.org/map-version-history";
          let pfLayerIds = ["region-as-oc-1","region-as-oc-2","region-as-oc-3","region-as-oc-4","region-as-oc-5",
          "region-as-oc-6","region-as-oc-7","region-as-oc-8","region-eu-af-1","region-eu-af-2","region-eu-af-3",
          "region-eu-af-4","region-eu-af-5","region-eu-af-6","region-eu-af-7","region-eu-af-8","region-na-sa-1",
          "region-na-sa-2","region-na-sa-3","region-na-sa-4","region-na-sa-5","region-na-sa-6","region-eu-af-9",
          "region-na-sa-7", "water"];
          let { dataLayerPaintProperties, dataKey, degrees } = {"dataLayerPaintProperties":["step",["get","data_2c_mid"],"#f5f5f5",-99998,"#e6e6e6",-88887,"#515866",1,"#0ed5a3",8,"#0099e4",31,"#8be1ff",91,"#ff45d0",181,"#d70066"],"tempUnit":"°C","degrees":2,"dataKey":"data_2c"};
          let dataset = {"__typename":"PfMap","mapStyleId":"clhyrwhlt02ae01qu6uojdjhx","name":"Days above 38°C (100°F)","stops":[1,8,31,91,181],"percentageStops":null,"binHexColors":["#515866","#0ed5a3","#0099e4","#8be1ff","#ff45d0","#d70066"],"isDiff":false,"step":1,"binLabels":null,"binningType":"range","slug":"days_above_38c","mapVersion":3,"isLatest":true,"dataLabels":["Cooler year","Average year","Warmer year"],"methodUsedForMid":"mean","dataset":{"__typename":"PfDataset","id":40106,"name":"Number of days maximum temperature above 38°C (100°F)","unit":"days","minValue":0,"maxValue":365,"dataVariables":["5th percentile","average","95th percentile"],"pfDatasetUnitByUnit":{"__typename":"PfDatasetUnit","unitLong":"Number of days per year"},"pfDatasetParentCategoryByParentCategory":{"__typename":"PfDatasetParentCategory","name":"heat","label":"Maps of temperature"},"subCategory":"increasing heat"}};
          const climateZones = [{"name":"Tropical","description":"","list":[{"name":"Tropical rainforest","value":11,"code":"Af","description":"","color":""},{"name":"Tropical savannah","value":12,"code":"Aw","description":"","color":""},{"name":"Tropical monsoon","value":13,"code":"Am","description":"","color":""}]},{"name":"Arid","description":"","list":[{"name":"Arid desert","value":21,"code":"BW","description":"","color":""},{"name":"Semi-arid steppe","value":22,"code":"BS","description":"","color":""}]},{"name":"Mild temperature","description":"","list":[{"name":"Temperate dry summer","value":31,"code":"Cs","description":"","color":""},{"name":"Temperate dry winter","value":32,"code":"Cw","description":"","color":""},{"name":"Temperate humid","value":33,"code":"Cf","description":"","color":""}]},{"name":"Continental","description":"","list":[{"name":"Continental dry summer","value":41,"code":"Ds","description":"","color":""},{"name":"Continental dry winter","value":42,"code":"Dw","description":"","color":""},{"name":"Continental humid","value":43,"code":"Df","description":"","color":""}]},{"name":"Ice","description":"","list":[{"name":"Polar tundra","value":51,"code":"ET","description":"","color":""},{"name":"Polar ice cap","value":52,"code":"EF","description":"","color":""}]}];
          mapboxgl.accessToken = 'pk.eyJ1IjoicHJvYmFibGVmdXR1cmVzIiwiYSI6ImNsaThxcXF1YjA5ajgzZHBnemJtNGptMnAifQ.PnPUBROiVfA8wwulm3lghQ';
          let tempUnit = '°C';
          const isFrequent = dataset?.dataset.unit === "x as frequent";
          const climateZoneDescs = undefined;
          const showComparisonMaps = true;
          let map, beforeMap, afterMap;
          let longitude=null, latitude=null, popup=null, mapClicked, featuresBefore=[], featuresAfter=[], features=[];
          let { dataKeyBefore, dataKeyAfter,dataLayerPaintPropertiesBefore, dataLayerPaintPropertiesAfter } = {"show":true,"dataKeyBefore":"data_baseline","dataKeyAfter":"data_2c","dataLayerPaintPropertiesBefore":["step",["get","data_baseline_mid"],"#f5f5f5",-99998,"#e6e6e6",-88887,"#515866",1,"#0ed5a3",8,"#0099e4",31,"#8be1ff",91,"#ff45d0",181,"#d70066"],"dataLayerPaintPropertiesAfter":["step",["get","data_2c_mid"],"#f5f5f5",-99998,"#e6e6e6",-88887,"#515866",1,"#0ed5a3",8,"#0099e4",31,"#8be1ff",91,"#ff45d0",181,"#d70066"],"degreesBefore":0.5,"degreesAfter":2};
          let isTempMap = dataset.dataset.pfDatasetUnitByUnit.unitLong.toLowerCase().includes("temp");
          if(showComparisonMaps) {
            beforeMap = new mapboxgl.Map({
              container: 'beforeMap', style: 'mapbox://styles/probablefutures/clhyrwhlt02ae01qu6uojdjhx', 
              center: [31.254404499999964,30.06597606924805], 
              zoom: 2.2, minZoom: 2.2, maxZoom: 10, projection: 'mercator'});
            beforeMap.addControl(new mapboxgl.NavigationControl());
            beforeMap.on("style.load", function() {
              let { layers } = beforeMap?.getStyle();
              layers.forEach(function({id, type}){
                if (id.includes('region-')) {
                  beforeMap?.setPaintProperty(id, "fill-color", dataLayerPaintPropertiesBefore);
                  beforeMap?.setPaintProperty(id, "fill-antialias", ["step", ["zoom"], false, 6, true]);
                  beforeMap?.setPaintProperty(id, "fill-outline-color", "#ffffff");
                } else if (type === "symbol" || id.includes("road")) beforeMap.setLayoutProperty(id, "visibility", "visible");
              });
            });
            afterMap = new mapboxgl.Map({ 
              container: 'afterMap', style: 'mapbox://styles/probablefutures/clhyrwhlt02ae01qu6uojdjhx', 
              center: [31.254404499999964, 30.06597606924805], 
              zoom: 2.2, minZoom: 2.2, maxZoom: 10, projection: 'mercator'});
            afterMap.addControl(new mapboxgl.NavigationControl());
            afterMap.on("style.load", function() {
              let { layers } = afterMap?.getStyle();
              layers.forEach(function({id, type}) {
                if (id.includes('region-')) {
                  afterMap?.setPaintProperty(id, "fill-color", dataLayerPaintPropertiesAfter);
                  afterMap?.setPaintProperty(id, "fill-antialias", ["step", ["zoom"], false, 6, true]);
                  afterMap?.setPaintProperty(id, "fill-outline-color", "#ffffff");
                } else if (type === "symbol" || id.includes("road")) afterMap.setLayoutProperty(id, "visibility", "visible");
              });
            });
            beforeMap.on('click', pfLayerIds , function(e) {
              latitude = e.lngLat.lat;
              longitude = e.lngLat.lng;
              mapClicked = "before";
              const afterMapFeatures = afterMap.queryRenderedFeatures([e.point.x, e.point.y]);
              featuresBefore = e.features;
              featuresAfter = afterMapFeatures;
              handleMapClick(beforeMap, dataKeyBefore, e.features);
              handleMapClick(afterMap, dataKeyAfter, afterMapFeatures);
            });
            afterMap.on('click', pfLayerIds, function(e) {
              latitude = e.lngLat.lat;
              longitude = e.lngLat.lng;
              mapClicked = "after";
              const beforeMapFeatures = afterMap.queryRenderedFeatures([e.point.x, e.point.y]);
              featuresAfter = e.features;
              featuresBefore = beforeMapFeatures;
              handleMapClick(afterMap, dataKeyAfter, e.features);
              handleMapClick(beforeMap, dataKeyBefore, beforeMapFeatures);
            });
            let compareMap = new mapboxgl.Compare(beforeMap, afterMap, "#comparison-container", {});
          }
          else {
            map = new mapboxgl.Map({ 
              container: 'map', style: 'mapbox://styles/probablefutures/clhyrwhlt02ae01qu6uojdjhx', 
              center: [31.254404499999964,30.06597606924805],
              zoom: 2.2, minZoom: 2.2, maxZoom: 10, projection: 'mercator'});
            map.addControl(new mapboxgl.NavigationControl());
            map.on("style.load", function() {
              let { layers } = map?.getStyle();
              layers.forEach(function({id, type}) {
                if (id.includes('region-')) {
                  map?.setPaintProperty(id, "fill-color", dataLayerPaintProperties);
                  map?.setPaintProperty(id, "fill-antialias", ["step", ["zoom"], false, 6, true]);
                  map?.setPaintProperty(id, "fill-outline-color", "#ffffff");
                } else if (type === "symbol" || id.includes("road")) map.setLayoutProperty(id, "visibility", "visible");
              });
            });
            map.on('click', pfLayerIds, function(e) {
              latitude = e.lngLat.lat;
              longitude = e.lngLat.lng;
              features = e.features;
              handleMapClick(map, dataKey, features);
            });
          }
          function displayHeader() {
            const headerDiv = document.querySelector(".embeddable-map-header");
            const headerDesc = document.createElement("p");
            headerDesc.className = "embeddable-map-header-description";
            headerDesc.textContent = showComparisonMaps ? dataset.name : dataset.name + " in a " + degrees + "°C " + "warming scenario";
            headerDiv.appendChild(headerDesc);
          }
          function displayBottomLink() {
            const link = document.createElement("a");
            link.target = "_blank";
            link.target = "noopener noreferrer";
            link.href = MAP_VERSION_URL;
            link.textContent = "Probable Futures map v" + dataset.mapVersion;
            link.className = "embeddable-bottom-link";
            document.body.appendChild(link);
          }
          function displayClimateZoneKey() {
            const czKeyContainer = document.createElement("div");
            czKeyContainer.className = "climate-zones-key-container";
            const czBinsContainer = document.createElement("div");
            czBinsContainer.className = "cz-bins-container";
            const embeddableKeyContainer = document.createElement("div");
            embeddableKeyContainer.className = "embeddable-key-container";

            let index = 0;
            climateZones.map(group => {
              const czBinContainer = document.createElement("div");
              czBinContainer.className = "cz-bin-container";
              group.list?.map((climateZone) => {
                const color = dataset.binHexColors[index++];
                const czColorBinWrapper = document.createElement("div");
                czColorBinWrapper.className = "cz-color-bin-wrapper";

                const czKeyColor = document.createElement("div");
                czKeyColor.className = "cz-key-color";
                czKeyColor.style.backgroundColor = color;

                const czKeyBin = document.createElement("span");
                czKeyBin.className = "cz-key-bin";
                czKeyBin.textContent = climateZone.name;
                
                czColorBinWrapper.appendChild(czKeyColor);
                czColorBinWrapper.appendChild(czKeyBin);;
                czBinContainer.appendChild(czColorBinWrapper);
                czBinsContainer.appendChild(czBinContainer);
              });
            });
            czKeyContainer.appendChild(czBinsContainer);
            embeddableKeyContainer.appendChild(czKeyContainer);
            document.body.appendChild(embeddableKeyContainer);
          }
          function displayKeyToggle() {
            const toggleContainer = document.createElement("div");
            const isChecked = tempUnit === "°F";
            toggleContainer.className = "embeddable-toggle-container";
            
            const toggleInput = document.createElement("input");
            toggleInput.className = "embeddable-toggle-input";
            toggleInput.id = "toggle";
            toggleInput.type = "checkbox";
            toggleInput.checked = isChecked;
            toggleInput.addEventListener('change', handleTempToggleChange);
            
            const toggleLabel = document.createElement("label");
            toggleLabel.htmlFor = "toggle";
            toggleLabel.className = "embeddable-toggle-label";

            const toggle = document.createElement("div");
            toggle.className = "embeddable-toggle";

            const toggleOptionLeft = document.createElement("span");
            toggleOptionLeft.className = "embeddable-toggle-option";
            toggleOptionLeft.id = "toggle-option1";
            if(isChecked) {toggleOptionLeft.style.color = "#2a172d"} 
            else {toggleOptionLeft.style.color = "#fdfdfd"}
            toggleOptionLeft.textContent = "°C";

            const toggleOptionRight = document.createElement("span");
            toggleOptionRight.className = "embeddable-toggle-option";
            toggleOptionRight.id = "toggle-option2";
            if(isChecked) {toggleOptionRight.style.color = "#fdfdfd"} 
            else {toggleOptionRight.style.color = "#2a172d"}
            toggleOptionRight.textContent = "°F";

            const toggleSpan = document.createElement("span");
            toggleSpan.className = "toggle-span";
            
            toggle.appendChild(toggleOptionLeft);
            toggle.appendChild(toggleOptionRight);
            toggle.appendChild(toggleSpan);
            toggleLabel.appendChild(toggle);
  
            toggleContainer.appendChild(toggleInput);
            toggleContainer.appendChild(toggleLabel);

            return toggleContainer;
          }
          function displayKey() {
            // create main divs
            const embeddableKeyContainer = document.createElement("div");
            embeddableKeyContainer.className = "embeddable-key-container";
            const mapKeyContainer = document.createElement("div");
            mapKeyContainer.className = "map-key-container";
            const keyContent = document.createElement("div");
            keyContent.className = "map-key-content";
            const keyHeader = document.createElement("div");
            keyHeader.className = "map-key-header";
            const label = document.createElement("span");
            label.className = "map-key-label";
            const keyRow = document.createElement("div");
            keyRow.className = "map-key-row";
            keyHeader.appendChild(label);
            keyContent.appendChild(keyHeader);
            keyContent.appendChild(keyRow);
            mapKeyContainer.appendChild(keyContent);
            embeddableKeyContainer.appendChild(mapKeyContainer);
            document.body.appendChild(embeddableKeyContainer);
            
            if(isTempMap) {
              keyHeader.appendChild(displayKeyToggle());
            }
            label.textContent = isTempMap ? dataset.dataset.pfDatasetUnitByUnit.unitLong.replace("°C", tempUnit) : dataset.dataset.pfDatasetUnitByUnit.unitLong;

            const binsContainerDiv = document.createElement("div");
            binsContainerDiv.className = "map-key-bins-container";
            dataset.binHexColors.map(function(color, index) {
              const [from, to] = getBinLabel(dataset.stops, index, dataset.dataset.pfDatasetUnitByUnit.unitLong, dataset.dataset.minValue, dataset.dataset.maxValue, dataset.step, tempUnit, dataset.isDiff, isFrequent);
              const binContainerDiv = document.createElement("div");
              const colorDiv = document.createElement("div");
              const binSpan = document.createElement("span");
              binContainerDiv.className = "map-key-bin-container";
              colorDiv.className = "map-key-color";
              binSpan.className = "map-key-bin";
              colorDiv.style.backgroundColor = color;

              if(dataset.binLabels) {
                const innerBinSpan = document.createElement("span");
                innerBinSpan.textContent = dataset.binLabels[index];
                binSpan.appendChild(innerBinSpan);
              } else if (to !== undefined) {
                const innerBinSpan = document.createElement("span");
                innerBinSpan.className = "map-key-inner-bin-label";
                const dashSpan = document.createElement("span");
                const fromText = document.createTextNode(from);
                const toText = document.createTextNode(to);
                dashSpan.textContent = "-";
                innerBinSpan.appendChild(fromText);
                innerBinSpan.appendChild(dashSpan);
                innerBinSpan.appendChild(toText);
                binSpan.appendChild(innerBinSpan);
              } else {
                const innerBinSpan = document.createElement("span");
                const fromText = document.createTextNode(from);
                innerBinSpan.appendChild(fromText);
                binSpan.appendChild(innerBinSpan);
              }
              binContainerDiv.appendChild(colorDiv);
              binContainerDiv.appendChild(binSpan);
              binsContainerDiv.appendChild(binContainerDiv);
            });
            keyRow.appendChild(binsContainerDiv);
          }
          function handleMapClick(map, key, features) {
            map._popups.forEach(popup => popup.remove());
            let dataFeature = features ? 
              features.find(function(feature) { 
                return feature.layer.id.includes("region-")
              }) 
              : undefined;
            let selectedData = {
              mid:  dataFeature?.properties[key + "_mid"],
              low: dataFeature?.properties[key + "_low"],
              high: dataFeature?.properties[key + "_high"]
            };
            let showInF = isTempMap && tempUnit === "°F";
            let showBaselineDetails = dataset.isDiff && degrees !== 0 && !isFrequent;
            let isMidValid = selectedData.mid !== undefined && selectedData.mid !== -99999 && selectedData.mid !== -88888;
            let title = "";
            if (dataset.dataset.unit === "class" && dataset.binLabels && isMidValid) title = getLabelByValue(selectedData.mid, dataset.binningType, dataset.binLabels, dataset.stops) || "";
            else if (datasetsWithMidValuesOnly.indexOf(dataset.dataset.id) !== -1) title = "Expected outcome";
            else title = "Expected range of outcomes";
            let result = `<div><div class="popover-title">${title}</div>`;
            if (!isMidValid) result += "<span class='popover-no-data'>No data here</span>";
            else if(dataset.dataset.unit === "class") {
              let climateZone = getLabelByValue(selectedData.mid, dataset.binningType, dataset.binLabels, dataset.stops);
              let climateZoneDesc = "";
              if (climateZone && climateZoneDescs) {
                let name = "description_" + climateZone.toLowerCase().replace(/-|\s/g, "_");
                climateZoneDesc = climateZoneDescs[name];
              }
              result += `<div class='popover-description'>${climateZoneDesc}</div>`;
            }
            else {
              let lowValue = showInF ? convertCToF(selectedData.low) : selectedData.low;
              let highValue = showInF ? convertCToF(selectedData.high) : selectedData.high;
              let meanValue = showInF ? convertCToF(selectedData.mid) : selectedData.mid;
              let showMidValueLabel = !dataset?.isDiff || lowValue !== undefined || highValue !== undefined;
              function getMidValue() {
                if (meanValue === undefined) return null;
                let prefix = "", suffix = "";
                if (isFrequent && meanValue >= 1) suffix = "x";
                else if (showBaselineDetails && meanValue > 0) prefix = "+";
                return prefix + meanValue + suffix;
              }
              function getValue(value, getter) {
                if (dataset?.binLabels) return getLabelByValue(value, dataset.binningType, dataset.binLabels, dataset.stops);
                else if (getter) return getter();
                return showBaselineDetails && value > 0 ? `+${value}` : value;
              }
              let popoverContent = "<div class='popover-row-container'>";
              let fontSize = dataset.binLabels ? "14px;" : "20px;";
              let fontSizeMid = dataset.binLabels ? "24px;" : "40px;";
              let valueMargin = dataset.binLabels ? "10px 0 4px;" : "18px 0 4px;";
              if(lowValue !== undefined) popoverContent += `<div class="popover-value-container"><span style="font-size:${fontSize};margin:${valueMargin}" class="popover-value">${getValue(lowValue)}</span><span class="popover-label">${dataset?.dataLabels[0]}</span></div>`;
              if(meanValue !== undefined) {
                popoverContent += "<div class='popover-value-container'>";
                if (isFrequent && meanValue < 1) popoverContent += "<span class='popover-mean-frequency-text'>Less frequent</span>";
                else popoverContent += `<span style="font-size:${fontSizeMid}" class="popover-avg-value">${getValue(meanValue, getMidValue)}</span>`
                if(showMidValueLabel) popoverContent+= `<span class="popover-label">${dataset?.dataLabels[1]}</span>`;
                popoverContent += "</div>";
              }
              if(highValue !== undefined) popoverContent += `<div class="popover-value-container"><span style="font-size:${fontSize};margin:${valueMargin}" class="popover-value">${getValue(highValue)}</span><span class="popover-label">${dataset?.dataLabels[2]}</span></div>`;
              popoverContent += "</div>";
              result += popoverContent;
            }
            result += "</div>";
            popup = new mapboxgl.Popup({anchor: "top", maxWidth:"none"})
            .setLngLat({lng: longitude, lat: latitude})
            .setHTML(result)
            .addTo(map);
          }
          function handleTempToggleChange() {
            tempUnit = tempUnit === "°C" ? "°F" : "°C";
            const isChecked = tempUnit === "°F";
            dataset.binHexColors.map(function(color, index) {
              const [from, to] = getBinLabel(dataset.stops,index,dataset.dataset.pfDatasetUnitByUnit.unitLong,dataset.dataset.minValue,dataset.dataset.maxValue,dataset.step,tempUnit,dataset.isDiff,isFrequent);
              const innerBinSpan = document.getElementsByClassName("map-key-inner-bin-label")[index];
              if(innerBinSpan) {
                while (innerBinSpan.firstChild) {
                  innerBinSpan.removeChild(innerBinSpan.firstChild);
                }
                const dashSpan = document.createElement("span");
                const fromText = document.createTextNode(from);
                const toText = document.createTextNode(to);
                dashSpan.textContent = "-";
                innerBinSpan.appendChild(fromText);
                innerBinSpan.appendChild(dashSpan);
                innerBinSpan.appendChild(toText);
              }
            });
            const toggleOptionLeft = document.getElementById("toggle-option1");
            if(isChecked) toggleOptionLeft.style.color = "#2a172d";
            else toggleOptionLeft.style.color = "#fdfdfd";

            const toggleOptionRight = document.getElementById("toggle-option2");
            if(isChecked) toggleOptionRight.style.color = "#fdfdfd";
            else toggleOptionRight.style.color = "#2a172d";

            if(!showComparisonMaps) {
              handleMapClick(map, dataKey, features);
            }
            else {
              if (beforeMap._popups.length > 0) handleMapClick(beforeMap, dataKeyBefore, featuresBefore);
              if (afterMap._popups.length > 0) handleMapClick(afterMap, dataKeyAfter, featuresAfter);
            }
          };
          displayHeader();
          displayBottomLink();
          if(dataset.dataset.unit === "class") displayClimateZoneKey();
          else displayKey();
        })();
      </script>
    </body>
  </html>